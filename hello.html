<!doctype html>
<html lang="de"l>
<head>
<meta charset="utf-8">
<title>Ein erstes Assembler-Programm</title>
<link rel="stylesheet" type="text/css" href="slides/slides.css"></head>
<body>
<h1>Ein erstes Assembler-Programm</h1>
<div class="slides">
<div><div>
<h1>Ein erstes Assembler-Programm</h1>
</div>

<ul><li>
 Dieses Kapitel beschreibt ein minimales Assembler-Programm für den
  Raspberry Pi
</li><li>
 Dieses Programm gibt einen fester Text aus
</li><li>
 Dabei wird nicht die C-Bibliothek verwendet
</li><li>
 Sondern nur direkte Aufrufe von Kernel-Funktionen
</li></ul></div>

<div><div>
<code>

<span class="macro">@globdef(<span class="name">file: hello.S</span>)</span><br/>

<span class="in1"></span><span class="macro">@expand(<span class="name">parts</span>)</span><br/>

<span class="macro">@end(<span class="name">file: hello.S</span>)</span><br/>

</code>
</div>

<ul><li>
 Das Programm besteht aus mehreren Teilen
</li></ul></div>

<div><div>
<code>

<span class="macro">@def(<span class="name">parts</span>)</span><br/>

<span class="in1"></span><span class="macro">@expand(<span class="name">symbols</span>)</span><br/>

<span class="macro">@end(<span class="name">parts</span>)</span><br/>

</code>
</div>

<ul><li>
 Am Anfang des Programms stehen Symbol-Definitionen
</li><li>
 Anstatt von nackten Zahlen verwendet das Programm beschreibende Namen
</li><li>
 und ist so verständlicher
</li></ul></div>

<div><div>
<code>

<span class="macro">@add(<span class="name">parts</span>)</span><br/>

<span class="in1"></span>.<span class="var">data</span><br/>

<span class="in1"></span><span class="macro">@expand(<span class="name">data</span>)</span><br/>

<span class="macro">@end(<span class="name">parts</span>)</span><br/>

</code>
</div>

<ul><li>
 In der Daten-Sektion stehen Daten, die das Programm verwendet
</li><li>
 Dies können Zahlen oder Texte sein
</li><li>
 Oder nur ein Speicherbereich, den das Programm während der Laufzeit
  braucht
</li></ul></div>

<div><div>
<code>

<span class="macro">@add(<span class="name">parts</span>)</span><br/>

<span class="in1"></span>.<span class="var">text</span><br/>

<span class="in1"></span><span class="macro">@expand(<span class="name">code</span>)</span><br/>

<span class="macro">@end(<span class="name">parts</span>)</span><br/>

</code>
</div>

<ul><li>
 Zum Schluss steht das eigentliche Programm
</li><li>
 in der Text-Sektion
</li></ul></div>

<div><div>
<code>

<span class="macro">@def(<span class="name">code</span>)</span><br/>

<span class="in1"></span>.<span class="var">global</span> <span class="var">_start</span><br/>

<span class="var">_start</span>:<br/>

<span class="in1"></span><span class="macro">@expand(<span class="name">write</span>)</span><br/>

<span class="in1"></span><span class="macro">@expand(<span class="name">exit</span>)</span><br/>

<span class="macro">@end(<span class="name">code</span>)</span><br/>

</code>
</div>

<ul><li>
 Das Programm gibt nur die Nachricht aus
</li><li>
 und beendet sich danach selber
</li></ul></div>

</div>
<h2>Programm beenden</h2>
<div class="slides">
<div><div>
<h2>Programm beenden</h2>
</div>

<ul><li>
 Das Programm muss sich mit dem Aufruf des <code>exit</code>-Traps beenden
</li><li>
 Ansonsten stürzt das Programm ab
</li></ul></div>

<div><div>
<code>

<span class="macro">@def(<span class="name">symbols</span>)</span><br/>

<span class="in1"></span>.<span class="var">equ</span> <span class="var">exit</span>, <span class="num">1</span><br/>

<span class="in1"></span>.<span class="var">equ</span> <span class="var">exit_success</span>, <span class="num">0</span><br/>

<span class="macro">@end(<span class="name">symbols</span>)</span><br/>

</code>
</div>

<ul><li>
 Der Exit-Trap hat die Nummer <code>1</code>
</li><li>
 und erwartet den Return-Code im Register <code>r0</code>
</li><li>
 Mit dem Return-Code <code>0</code> signalisiert das Programm einen fehlerlosen
  Ablauf
</li></ul></div>

<div><div>
<code>

<span class="macro">@def(<span class="name">exit</span>)</span><br/>

<span class="in1"></span><span class="var">mov</span> <span class="var">r7</span>, #<span class="var">exit</span><br/>

<span class="in1"></span><span class="var">mov</span> <span class="var">r0</span>, #<span class="var">exit_success</span><br/>

<span class="in1"></span><span class="var">swi</span> <span class="num">0</span><br/>

<span class="macro">@end(<span class="name">exit</span>)</span><br/>

</code>
</div>

<ul><li>
 Die Trap-Nummer steht in Register <code>r7</code>
</li><li>
 Die Argumente des Traps stehen in den Registern <code>r0</code> bis <code>r6</code>
</li><li>
 <code>exit</code> hat nur ein Argument
</li><li>
 Aus diesem Trap erfolgt kein Rücksprung
</li></ul></div>

</div>
<h2>Nachricht ausgeben</h2>
<div class="slides">
<div><div>
<h2>Nachricht ausgeben</h2>
</div>

<ul><li>
 Gibt eine feste Nachricht aus
</li><li>
 Die Nachricht liegt in der Daten-Sektion
</li></ul></div>

<div><div>
<code>

<span class="macro">@def(<span class="name">data</span>)</span><br/>

<span class="var">message</span>:<br/>

<span class="in1"></span>.<span class="var">ascii</span> <span class="str">"Hallo Welt\n"</span><br/>

<span class="in1"></span>.<span class="var">equ</span> <span class="var">message_size</span>, . - <span class="var">message</span><br/>

<span class="macro">@end(<span class="name">data</span>)</span><br/>

</code>
</div>

<ul><li>
 In der Daten-Sektion liegt die Nachricht, die das Programm ausgibt
</li><li>
 Der Assembler berechnet die Länge der Nachricht
</li><li>
 und hält sie in einem Symbol fest
</li><li>
 Die Nachricht enthält kein abschließendes Null-Byte
</li></ul></div>

<div><div>
<code>

<span class="macro">@add(<span class="name">symbols</span>)</span><br/>

<span class="in1"></span>.<span class="var">equ</span> <span class="var">write</span>, <span class="num">4</span><br/>

<span class="in1"></span>.<span class="var">equ</span> <span class="var">stdout</span>, <span class="num">1</span><br/>

<span class="macro">@end(<span class="name">symbols</span>)</span><br/>

</code>
</div>

<ul><li>
 Die Trap-Nummer für <code>write</code> ist <code>4</code>
</li><li>
 Und der offene Datei-Handle für die Standard-Ausgabe ist <code>1</code>
</li></ul></div>

<div><div>
<code>

<span class="macro">@def(<span class="name">write</span>)</span><br/>

<span class="in1"></span><span class="var">mov</span> <span class="var">r7</span>, #<span class="var">write</span><br/>

<span class="in1"></span><span class="var">mov</span> <span class="var">r0</span>, #<span class="var">stdout</span><br/>

<span class="in1"></span><span class="var">ldr</span> <span class="var">r1</span>, =<span class="var">message</span><br/>

<span class="in1"></span><span class="var">ldr</span> <span class="var">r2</span>, =<span class="var">message_size</span><br/>

<span class="in1"></span><span class="var">swi</span> <span class="num">0</span><br/>

<span class="macro">@end(<span class="name">write</span>)</span><br/>

</code>
</div>

<ul><li>
 Der <code>write</code>-Trap hat die Ausgabe-Datei als erstes Argument
</li><li>
 Das zweite Argument ist der Start der Bytes, die ausgegeben werden
</li><li>
 Das dritte Argument ist die Anzahl der Bytes
</li></ul></div>

